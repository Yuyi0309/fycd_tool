<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>年度講師資料整理系統 - 跨年追蹤版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; line-height: 1.6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 14px; }
        .status-bar { padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #e2e8f0; font-size: 0.9rem; }
        button { padding: 10px 25px; cursor: pointer; border: none; border-radius: 4px; background: #48BB78; color: white; font-size: 1rem; font-weight: bold; }
        button:hover { background: #38a169; }
        #data-table { margin-top: 20px; border: 1px solid #ddd; }
        .loading { color: #eb8f34; font-weight: bold; }
        h2 { color: #2d3748; margin-top: 0; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. 系統狀態</h2>
        <div id="loadStatus" class="status-bar">正在初始化並讀取歷年資料庫 (114-110)...</div>
    </div>

    <div class="card">
        <h2>2. 貼上新年度名單</h2>
        <p>格式範例：崇德 [Tab] 正承佛院 [Tab] 講師1 [Tab] 講師2 ...</p>
        <textarea id="rawInput" placeholder="在此貼上名單..."></textarea>
        <div class="controls" style="margin-top:10px;">
            <button onclick="processData()">解析並自動對比資料</button>
        </div>
    </div>

    <div class="card">
        <h2>3. 資料確認與登打</h2>
        <p>勾選「確認」欄位，匯出時該員備註會填入 "V"。您可以直接修改任何格子。</p>
        <div id="data-table"></div>
        <div class="controls" style="margin-top:20px;">
            <button onclick="exportToExcel()" style="background: #4A90E2;">產生並下載 115 年度 Excel</button>
        </div>
    </div>

    <script>
        let table;
        // 依照年份由新到舊排列
        const dbFiles = ['114master_database.xlsx', '113master_database.xlsx', '112master_database.xlsx', '111master_database.xlsx', '110master_database.xlsx'];
        let masterDatabases = {}; // 存放各年資料 { '114': [data], '113': [data] ... }

        // 頁面開啟時，循序讀取所有資料庫
        window.onload = async () => {
            const statusDiv = document.getElementById('loadStatus');
            for (let file of dbFiles) {
                const year = file.substring(0, 3);
                try {
                    const response = await fetch(file);
                    if (!response.ok) throw new Error("檔案不存在");
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    masterDatabases[year] = XLSX.utils.sheet_to_json(firstSheet);
                    statusDiv.innerHTML += `<br>✅ 已載入 ${year} 年度資料庫`;
                } catch (e) {
                    statusDiv.innerHTML += `<br>❌ 無法讀取 ${file} (可能未上傳)`;
                }
            }
            statusDiv.innerHTML = statusDiv.innerHTML.replace("正在初始化", "資料庫準備就緒");
        };

        // 核心搜尋邏輯：從 114 往 110 找
        function findPersonLatestInfo(name) {
            for (let file of dbFiles) {
                const year = file.substring(0, 3);
                const db = masterDatabases[year];
                if (db) {
                    const person = db.find(d => String(d.姓名).trim() === name);
                    if (person) return { ...person, foundYear: year }; // 找到就回傳並停止
                }
            }
            return null; // 全都找不到
        }

        function processData() {
            const input = document.getElementById('rawInput').value;
            const lines = input.trim().split('\n');
            let resultList = [];
            let count = 1;

            lines.forEach(line => {
                if (!line.trim()) return; // 跳過空白行

                const parts = line.split(/\t/); 
                if (parts.length < 2) return;

                const region = parts[0].trim();   // 崇德 / 行德
                const unit = parts[1].trim();     // 正承佛院 / 正嶺
                const fullClassName = unit + region; // 組合為：正承佛院崇德
                
                const teachers = parts.slice(2).filter(name => name.trim() !== "");

                teachers.forEach(name => {
                    const cleanName = name.trim();
                    const info = findPersonLatestInfo(cleanName) || {};
                    
                    resultList.push({
                        序號: count++,
                        班別: fullClassName,
                        單位: info.單位 || "",
                        姓名: cleanName,
                        職位: info.職位 || "講師",
                        性別: info.性別 || "",
                        生日: info.生日 || "",
                        身分證字號: info.身分證字號 || "",
                        住址: info.住址 || "",
                        電話: info.電話 || "",
                        學歷: info.學歷 || "",
                        專長: info.專長 || "",
                        勾選: false,
                        備註: info.foundYear ? `(來源:${info.foundYear})` : ""
                    });
                });
            });

            renderTable(resultList);
        }

        function renderTable(data) {
            table = new Tabulator("#data-table", {
                data: data,
                layout: "fitColumns",
                maxHeight: "500px",
                columns: [
                    {title:"序號", field:"序號", width:60, headerSort:false},
                    {title:"班別", field:"班別", editor:"input", width:150},
                    {title:"姓名", field:"姓名", editor:"input", width:100},
                    {title:"確認(V)", field:"勾選", formatter:"tickCross", editor:true, hozAlign:"center", width:90},
                    {title:"電話", field:"電話", editor:"input"},
                    {title:"住址", field:"住址", editor:"input"},
                    {title:"生日", field:"生日", editor:"input"},
                    {title:"身分證字號", field:"身分證字號", editor:"input"},
                    {title:"備註", field:"備註", editor:"input"},
                ],
            });
        }

        async function exportToExcel() {
            if (!table) return alert("請先解析資料！");
            
            const editedData = table.getData();
            const response = await fetch('template.xlsx');
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer);
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];

            // 轉換資料格式以符合公版
            const finalExportData = editedData.map(item => ({
                "序號": item.序號,
                "班別": item.班別,
                "單位": item.單位,
                "姓名": item.姓名,
                "職位": item.職位,
                "性別": item.性別,
                "生日": item.生日,
                "身分證字號": item.身分證字號,
                "住址": item.住址,
                "電話": item.電話,
                "學歷": item.學歷,
                "專長": item.專長,
                "備註": item.勾選 ? "V" : item.備註
            }));

            XLSX.utils.sheet_add_json(worksheet, finalExportData, { origin: "A2", skipHeader: true });
            XLSX.writeFile(workbook, `115年度講師整理表_${new Date().getTime()}.xlsx`);
        }
    </script>
</body>
</html>
