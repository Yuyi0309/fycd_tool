<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è¬›å¸«è³‡æ–™æ•´ç† - Excel å€å¡Šé‚„åŸç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #555; margin: 0; padding: 20px; color: #333; }
        .setup-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-width: 1000px; margin-left: auto; margin-right: auto; }
        textarea { width: 100%; height: 100px; border: 1px solid #ccc; margin: 10px 0; font-family: monospace; }
        
        /* æ¨¡æ“¬ Excel å€å¡Šçš„æ¨£å¼ */
        .excel-block { 
            background: white; border: 2px solid #000; margin: 20px auto; 
            width: 1100px; position: relative; padding: 5px; overflow-x: auto;
        }
        .block-header { background: #e8f5e9; padding: 5px; font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 10px; }
        
        /* æ¨¡æ“¬ç¶²æ ¼ä½ˆå±€ */
        .grid-container { display: grid; grid-template-columns: repeat(34, 30px); grid-template-rows: repeat(6, 25px); gap: 1px; background: #ccc; border: 1px solid #000; }
        .cell { background: white; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 0.1px solid #eee; overflow: hidden; }
        .cell.editable { background: #fffde7; }
        .cell.v-zone { background: #e3f2fd; font-weight: bold; color: blue; }
        .cell:hover { border: 1px solid #2196f3; }

        .btn { padding: 10px 20px; background: #2e7d32; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-export { background: #1565c0; }
        .status { font-size: 13px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="setup-card">
        <h2>ğŸ“Š å¹´åº¦è³‡æ–™æ•´ç†ç³»çµ± (115å¹´å°ˆç”¨)</h2>
        <div id="loadStatus" class="status">æ­£åœ¨è¼‰å…¥ 110-114 è³‡æ–™åº«...</div>
        <p>è«‹è²¼å…¥åå–® (æ ¼å¼: ç³» [Tab] å–®ä½ [Tab] è¬›å¸«1 [Tab] è¬›å¸«2...)</p>
        <textarea id="rawInput" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—..."></textarea>
        <button class="btn" onclick="generateBlocks()">1. è§£æåå–®ä¸¦æå–å€å¡Š</button>
        <button class="btn btn-export" onclick="exportExcel()">2. ç”¢å‡º 115å¹´ Excel æª”æ¡ˆ</button>
    </div>

    <div id="editorArea">
        </div>

    <script>
        let dbWorkbooks = {};
        const years = ['114', '113', '112', '111', '110'];
        let currentDataBlocks = []; // å­˜æ”¾ç›®å‰ç·¨è¼¯ä¸­çš„æ‰€æœ‰äººè³‡æ–™(6x34é™£åˆ—)

        // åˆå§‹åŒ–ï¼šè®€å–æ‰€æœ‰ Excel æª”æ¡ˆ
        window.onload = async () => {
            const status = document.getElementById('loadStatus');
            for (let yr of years) {
                try {
                    const res = await fetch(`${yr}master_database.xlsx`);
                    const buf = await res.arrayBuffer();
                    dbWorkbooks[yr] = XLSX.read(buf);
                    status.innerHTML += `<br>âœ… ${yr}å¹´è³‡æ–™è¼‰å…¥æˆåŠŸ`;
                } catch (e) { status.innerHTML += `<br>âŒ æœªæ‰¾åˆ° ${yr}å¹´æª”æ¡ˆ`; }
            }
        };

        // æœå°‹é‚è¼¯ï¼šåœ¨æŒ‡å®šçš„ Workbook æ‰¾å§“åï¼Œå›å‚³é‚£ 6 åˆ—çš„è³‡æ–™
        function getBlockByName(name) {
            for (let yr of years) {
                const wb = dbWorkbooks[yr];
                if (!wb) continue;
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                // æ¯ 6 åˆ—ä¸€çµ„ï¼Œå§“ååœ¨æ¯ä¸€çµ„çš„ç¬¬ 3 åˆ— (Index 2), ç¬¬ 4 æ¬„ (Index 3, å³ D æ¬„)
                for (let i = 3; i < data.length; i += 6) {
                    if (data[i+2] && String(data[i+2][3]).trim() === name) {
                        // æŠ“å– 6x34 çš„ç¯„åœ
                        let block = [];
                        for (let r = 0; r < 6; r++) {
                            let row = data[i+r] || [];
                            while(row.length < 34) row.push(""); // è£œé½Š 34 æ¬„ (A-AH)
                            block.push(row);
                        }
                        return { data: block, year: yr };
                    }
                }
            }
            return null;
        }

        function generateBlocks() {
            const input = document.getElementById('rawInput').value.trim();
            const lines = input.split('\n');
            const area = document.getElementById('editorArea');
            area.innerHTML = "";
            currentDataBlocks = [];

            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length < 3) return;
                const className = parts[1] + parts[0]; // æ­£æ‰¿ä½›é™¢å´‡å¾·
                const teachers = parts.slice(2).filter(n => n.trim() !== "");

                teachers.forEach(name => {
                    let result = getBlockByName(name.trim());
                    let blockData;
                    let sourceInfo = "";

                    if (result) {
                        blockData = result.data;
                        sourceInfo = `(ä¾†æº: ${result.year}å¹´)`;
                    } else {
                        // æ²’è³‡æ–™å°±çµ¦ç©ºçš„ (34æ¬„ x 6åˆ—)
                        blockData = Array.from({length:6}, () => Array(34).fill(""));
                        blockData[2][3] = name; // å¡«å…¥å§“ååˆ° D6 ä½ç½®
                        sourceInfo = "(æ–°äººå“¡ - è«‹å¡«å¯«è³‡æ–™)";
                    }
                    
                    // å¼·åˆ¶æ›´æ–°ç­åˆ¥ (B4)
                    blockData[0][1] = className; 

                    currentDataBlocks.push(blockData);
                    renderVisualBlock(blockData, sourceInfo);
                });
            });
        }

        // ç¹ªè£½è¦–è¦ºåŒ–å€å¡Š (é«˜é‚„åŸ Excel æ¨£å¼)
        function renderVisualBlock(block, info) {
            const area = document.getElementById('editorArea');
            const container = document.createElement('div');
            container.className = 'excel-block';
            container.innerHTML = `<div class="block-header">è¬›å¸«ï¼š${block[2][3]} ${info}</div>`;

            const grid = document.createElement('div');
            grid.className = 'grid-container';

            // éæ­· 6x34 å€‹æ ¼å­
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 34; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    let val = block[r][c] || "";
                    cell.innerText = val;

                    // å®šç¾©ã€ŒV å‹¾é¸å€ã€(æ ¹æ“šä½ çš„åº§æ¨™è½‰æ›ç‚º 0-indexed)
                    // G4:H7 -> r0-3, c6-7
                    // N7:AA9 -> r3-5, c13-26
                    // AC4:AC9 -> r0-5, c28
                    // AE4:AE9 -> r0-5, c30
                    // AH4:AH9 -> r0-5, c33
                    const isVZone = (c >= 6 && c <= 7 && r <= 3) || 
                                    (c >= 13 && c <= 26 && r >= 3) ||
                                    (c == 28) || (c == 30) || (c == 33);

                    if (isVZone) {
                        cell.classList.add('v-zone');
                        cell.onclick = () => {
                            block[r][c] = (block[r][c] === "V") ? "" : "V";
                            cell.innerText = block[r][c];
                        };
                    } else if (c == 9 || c == 10) { // å‡è¨­é€šè¨Šåœ°å€å’Œé›»è©±åœ¨é€™äº›æ¬„ä½
                        cell.classList.add('editable');
                        cell.onclick = () => {
                            let newVal = prompt("è«‹è¼¸å…¥æ–°è³‡æ–™ï¼š", cell.innerText);
                            if (newVal !== null) {
                                block[r][c] = newVal;
                                cell.innerText = newVal;
                            }
                        };
                    }
                    grid.appendChild(cell);
                }
            }
            container.appendChild(grid);
            area.appendChild(container);
        }

        async function exportExcel() {
            if (currentDataBlocks.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");

            const res = await fetch('template.xlsx');
            const buf = await res.arrayBuffer();
            const wb = XLSX.read(buf);
            const ws = wb.Sheets[wb.SheetNames[0]];

            // é€ä¸€å°‡å€å¡Šå¡«å…¥ template (å¾ç¬¬ 4 åˆ—é–‹å§‹)
            currentDataBlocks.forEach((block, index) => {
                const startRow = 3 + (index * 6); // Excel index
                XLSX.utils.sheet_add_json(ws, block, { origin: {r: startRow, c: 0}, skipHeader: true });
            });

            XLSX.writeFile(wb, `115å¹´æ•´ç†å¾Œè¬›å¸«è¡¨.xlsx`);
        }
    </script>
</body>
</html>
