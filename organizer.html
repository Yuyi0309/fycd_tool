<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>115å¹´åº¦è¬›å¸«è³‡æ–™æ•´ç† (æ ¼å¼ä¿å­˜ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #333; color: white; padding: 20px; }
        .card { background: #fff; color: #333; padding: 20px; border-radius: 8px; max-width: 900px; margin: 0 auto 20px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; border: 1px solid #ccc; }
        .status-box { background: #eee; padding: 10px; font-size: 12px; margin-bottom: 10px; color: #666; }
        .btn { padding: 12px 24px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        
        /* æ¨¡æ“¬ Excel å€å¡Šé è¦½ */
        .block-preview { 
            background: white; border: 2px solid #000; margin: 20px auto; 
            width: 95%; padding: 10px; color: #000;
        }
        .v-cell { 
            display: inline-block; width: 30px; height: 30px; border: 1px solid #999; 
            text-align: center; line-height: 30px; cursor: pointer; background: #e3f2fd; 
        }
        .v-cell:hover { background: #bbdefb; }
        .v-checked { color: blue; font-weight: bold; background: #fff9c4; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ“Š 115å¹´åº¦è¬›å¸«è³‡æ–™æ•´ç†</h2>
        <div id="status" class="status-box">æ­£åœ¨é€£ç·šè³‡æ–™åº« (114-110)...</div>
        <textarea id="rawInput" placeholder="åœ¨æ­¤è²¼ä¸Šï¼šå´‡å¾· [Tab] æ­£æ‰¿ä½›é™¢ [Tab] è¬›å¸«åå–®..."></textarea>
        <button class="btn btn-blue" onclick="processList()">1. è§£æåå–®ä¸¦æ‰¾å°‹èˆŠè³‡æ–™</button>
        <button class="btn btn-green" onclick="exportFinalExcel()">2. åŒ¯å‡º 115å¹´ Excel (ä¿ç•™æ ¼å¼)</button>
    </div>

    <div id="displayArea"></div>

    <script>
        let masterData = []; // å­˜å„²æ‰€æœ‰æŠ“åˆ°çš„å€å¡Šè³‡æ–™
        const years = ['114', '113', '112', '111', '110'];
        let dbs = {};

        // åˆå§‹åŒ–ï¼šè®€å–æ‰€æœ‰è³‡æ–™åº«
        window.onload = async () => {
            const status = document.getElementById('status');
            for (let yr of years) {
                try {
                    const res = await fetch(`${yr}master_database.xlsx`);
                    const buf = await res.arrayBuffer();
                    const wb = new ExcelJS.Workbook();
                    await wb.xlsx.load(buf);
                    dbs[yr] = wb.getWorksheet(1);
                    status.innerHTML += `<br>âœ… å·²è®€å– ${yr}master_database.xlsx`;
                } catch (e) {
                    status.innerHTML += `<br>âŒ æ‰¾ä¸åˆ° ${yr}master_database.xlsx`;
                }
            }
        };

        // æœå°‹äººå“¡å€å¡Š (A:AH, 6åˆ—)
        function findPersonBlock(name) {
            for (let yr of years) {
                const sheet = dbs[yr];
                if (!sheet) continue;
                
                // å§“ååœ¨ D æ¬„ (ç¬¬4æ¬„)ï¼Œæ¯ 6 åˆ—ä¸€çµ„ï¼Œé€šå¸¸åœ¨ç¬¬ 6, 12, 18...åˆ—
                let foundRow = -1;
                sheet.eachRow((row, rowNum) => {
                    if (rowNum >= 4 && String(row.getCell(4).value).trim() === name) {
                        foundRow = rowNum;
                    }
                });

                if (foundRow !== -1) {
                    // é–å®šè©²å€å¡Šçš„èµ·é» (å¦‚æœæ˜¯ç¬¬ 6 åˆ—æ‰¾åˆ°ï¼Œèµ·é»å°±æ˜¯ç¬¬ 4 åˆ—)
                    const blockStart = foundRow - 2; 
                    let blockData = [];
                    for (let r = 0; r < 6; r++) {
                        let rowData = [];
                        for (let c = 1; c <= 34; c++) { // A åˆ° AH
                            const cell = sheet.getRow(blockStart + r).getCell(c);
                            rowData.push(cell.value);
                        }
                        blockData.push(rowData);
                    }
                    return { data: blockData, year: yr };
                }
            }
            return null;
        }

        function processList() {
            const input = document.getElementById('rawInput').value.trim();
            const lines = input.split('\n');
            const area = document.getElementById('displayArea');
            area.innerHTML = "";
            masterData = [];

            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length < 3) return;
                const fullClassName = parts[1] + parts[0]; // å–®ä½+ç³»
                const names = parts.slice(2).filter(n => n.trim() !== "");

                names.forEach(name => {
                    let result = findPersonBlock(name.trim());
                    let block;
                    if (result) {
                        block = result.data;
                        console.log(`æ‰¾åˆ° ${name} ä¾†è‡ª ${result.year}`);
                    } else {
                        // å»ºç«‹ç©ºç™½å€å¡Š
                        block = Array.from({length: 6}, () => Array(34).fill(null));
                        block[2][3] = name; // D6 å§“å
                    }
                    // æ›´æ–°ç­åˆ¥
                    block[0][1] = fullClassName; 
                    masterData.push(block);
                    renderUI(block);
                });
            });
        }

        function renderUI(block) {
            const div = document.createElement('div');
            div.className = 'block-preview';
            div.innerHTML = `<strong>è¬›å¸«ï¼š${block[2][3]}</strong> (é»æ“Šä¸‹æ ¼å¯åˆ‡æ› V)`;
            
            // ç°¡åŒ–é è¦½ï¼šåªæ”¾å‹¾é¸å€
            const vZone = document.createElement('div');
            vZone.style.marginTop = "10px";
            
            // ç¯„ä¾‹ï¼šé¡¯ç¤ºä¸€å€‹åˆ‡æ›æŒ‰éˆ•ä¾†è™•ç† AH4 (ç¬¬34æ¬„, ç¬¬1åˆ—) çš„å‹¾é¸
            const toggleV = (r, c, label) => {
                const span = document.createElement('span');
                span.className = 'v-cell' + (block[r][c] === 'V' ? ' v-checked' : '');
                span.innerText = block[r][c] === 'V' ? 'V' : ' ';
                span.onclick = () => {
                    block[r][c] = (block[r][c] === 'V' ? null : 'V');
                    span.innerText = (block[r][c] === 'V' ? 'V' : ' ');
                    span.classList.toggle('v-checked');
                };
                vZone.appendChild(document.createTextNode(label + ": "));
                vZone.appendChild(span);
            };

            toggleV(0, 33, "ç¾ä»»ç­åˆ¥(AH4)"); // èˆ‰ä¾‹
            div.appendChild(vZone);
            document.getElementById('displayArea').appendChild(div);
        }

        async function exportFinalExcel() {
            const res = await fetch('template.xlsx');
            const buf = await res.arrayBuffer();
            const wb = new ExcelJS.Workbook();
            await wb.xlsx.load(buf);
            const sheet = wb.getWorksheet(1);

            // å¾ç¬¬ 4 åˆ—é–‹å§‹å¡«å…¥
            masterData.forEach((block, index) => {
                const startRow = 4 + (index * 6);
                for (let r = 0; r < 6; r++) {
                    for (let c = 0; c < 34; c++) {
                        // é—œéµï¼šåªå¡«å€¼ï¼Œä¸æ”¹æ ¼å¼
                        if (block[r][c] !== null) {
                            sheet.getRow(startRow + r).getCell(c + 1).value = block[r][c];
                        }
                    }
                }
            });

            const outBuf = await wb.xlsx.writeBuffer();
            const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "115å¹´åº¦è³‡æ–™æ•´ç†åŒ¯å‡º.xlsx";
            link.click();
        }
    </script>
</body>
</html>
